sudo: required

services:
  - docker
  - redis-server

env:
  global:
    - HE_GITHUB_SECRET=test-secret
    - HE_GITHUB_CLIENTID=test-clientid
    - HE_GITHUB_CALLBACK_URL=http://127.0.0.1
    - HE_SESSION_SECRET=test-sessionsecret
    - HE_DAL_ENCRYPTION_KEY=test
    - HE_SERVER_URL=http://127.0.0.1
    - HE_VERSION=0.12.9

language: node_js

node_js:
  - 7

notifications:
  email: false

branches:
  only:
    - master

before_script:
  - npm version $HE_VERSION

after_success:
  - sudo apt-get update && sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-engine
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  - docker pull stono/hawkeye.ninja
  - docker pull stono/hawkeye.ninja-worker
  - docker pull stono/hawkeye.ninja-oneshot
  - docker pull stono/hawkeye:$HE_VERSION
  - docker tag stono/hawkeye:$HE_VERSION stono/hawkeye:latest
  - docker build -f Dockerfile -t stono/hawkeye.ninja --cache-from stono/hawkeye.ninja .
  - docker build -f Dockerfile.worker -t stono/hawkeye.ninja-worker --cache-from stono/hawkeye.ninja-worker .
  - docker build -f Dockerfile.oneshot -t stono/hawkeye.ninja-oneshot --cache-from stono/hawkeye.ninja-oneshot .
  - docker tag stono/hawkeye.ninja-oneshot:latest stono/hawkeye.ninja-oneshot:$HE_VERSION
  - docker push stono/hawkeye.ninja
  - docker push stono/hawkeye.ninja-worker
  - docker push stono/hawkeye.ninja-oneshot
  - docker push stono/hawkeye.ninja-oneshot:$HE_VERSION
